# 小鹅通订单同步脚本：需求与计划

本文档记录了小鹅通订单同步脚本的需求、遇到的问题以及当前的解决方案计划。

## 最终目标

构建一个基于云服务器的 BI 数据看板系统，实现：

* 多渠道数据整合（订单、售后、直播、用户等数据）
* 数据可视化展示
* 实时数据更新
* 灵活的数据分析能力

## 初始需求

*   从指定历史日期（2025-01-01）开始，同步小鹅通订单数据。
*   将订单数据存储以便后续查看和分析。
*   只使用订单列表 API (`xe.order.list.get/1.0.1`)，不调用订单详情 API。

## 已解决的问题与当前状态 (基于之前的对话)

1.  **历史数据同步:**
    *   最初使用 CSV 追加方式存储。
    *   实现了按时间分块同步历史数据。
    *   使用 `last_sync_timestamp_list_only.txt` 文件记录同步进度。
2.  **数据格式化:**
    *   **金额单位:** 确认 `price` (实付金额) 字段单位为 **元**，而 `coupon_price` (优惠券抵扣) 和 `refund_money` (退款金额) 单位为 **分**。脚本已修改为按此规则处理。
    *   **状态码映射:** 根据用户提供的最新 API 文档，更新了 `order_state` (订单状态), `resource_type` (资源类型), `ship_state` (发货状态) 的数字码到中文文本的映射。
    *   **字段调整:** 移除了不确定是否存在或单位的 `discount_price` 字段，移除了 `goods_img` (商品图片) 字段。
    *   **中文表头:** 更新了 CSV 文件的中文表头，使其更清晰。
    *   **保留原始码:** 对于未提供明确映射或定义不清晰的字段（如 `pay_way`, `client_type`, `collection_way`, `after_sales_state`, `team_buy_state`, `sales_state`），在输出中保留其原始数字码。

## 新增需求：处理14天内退款与福利发放

*   **场景:** 需要根据用户下单后 **14天内** 订单的最终状态来决定是否发放/取消福利。例如，用户第 1 天下单成功，第 7 天退款，需要能识别到这个退款状态，以便取消福利。
*   **挑战:** 当前仅追加新订单到 CSV 的方式无法有效跟踪已有订单的状态更新（如退款）。

## 优化后的解决方案：基于 PostgreSQL/MySQL 的数据仓库

考虑到最终目标是构建 BI 看板，我们将采用更强大的数据库解决方案：

1. **数据库选型：**
   * 使用  MySQL 替代 SQLite
   * 原因：
     - 更好的并发处理能力
     - 支持复杂的关系查询
     - 与 BI 工具的良好集成
     - 完善的权限管理
     - 适合多应用程序访问（同步脚本写入，BI 工具读取）

2. **模块化 ETL 架构：**
   * **提取 (Extract)：**
     - 独立的 API 调用模块
     - 支持多个数据源（订单、售后、直播等）
     - 错误重试和异常处理
   * **转换 (Transform)：**
     - 数据清洗和标准化
     - 状态码映射
     - 单位转换
     - 衍生指标计算
   * **加载 (Load)：**
     - 数据库写入逻辑（UPSERT）
     - 数据一致性检查
     - 性能优化

3. **数据库表设计：**
   * **核心表：**
     - `orders`（订单主表）
     - `order_items`（订单商品明细）
     - `users`（用户信息）
     - `products`（商品信息）
     - `refunds`（退款信息）
     - `live_streams`（直播信息）
   * 使用合适的索引优化查询性能
   * 建立表间关系确保数据一致性

4. **同步策略：**
   * **增量同步：**
     - 订单数据：每 30 分钟
     - 近期订单状态更新：每小时扫描最近 15 天
     - 用户和商品数据：每天完整同步一次
   * **错误处理：**
     - 详细的错误日志
     - 自动重试机制
     - 关键错误告警

5. **监控与维护：**
   * 同步任务执行状态监控
   * 数据一致性检查
   * 性能指标监控
   * 磁盘空间使用监控

## 部署架构

1. **服务器环境：**
   * 宝塔面板管理
   * Python 3.9+ 运行环境
   * PostgreSQL/MySQL 数据库服务
   * 定时任务调度

2. **目录结构：**
```
/www/wwwroot/xiaoe_sync/
├── config/
│   ├── database.py      # 数据库配置
│   └── api_config.py    # API 配置
├── src/
│   ├── extractors/      # 数据提取模块
│   ├── transformers/    # 数据转换模块
│   └── loaders/         # 数据加载模块
├── utils/               # 工具函数
├── logs/                # 日志文件
└── main.py             # 主程序
```

3. **自动化部署：**
   * 使用宝塔面板的计划任务
   * 配置监控和告警
   * 日志轮转
   * 数据备份策略

## 下一步计划

1. 详细设计数据库表结构（Schema）
2. 实现核心的订单同步模块
3. 搭建基础的数据库环境
4. 逐步扩展其他数据源的同步
5. 选择和集成合适的 BI 工具 